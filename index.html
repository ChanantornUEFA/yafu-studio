<!DOCTYPE html>
<html lang="th">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Chord Studio Pro</title>
<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#111;
  color:white;
}
  textarea{
  font-size:16px;
}

button{
  font-size:16px;
}

header{
  background:#000;
  padding:15px;
  font-size:22px;
  text-align:center;
  font-weight:bold;
}

.container{
  padding:20px;
}

button{
  padding:8px 14px;
  margin:5px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.primary{ background:#00c3ff; color:black; }
.danger{ background:#ff4444; color:white; }
.secondary{ background:#444; color:white; }

input, textarea{
  padding:8px;
  margin:5px 0;
  width:100%;
  border-radius:6px;
  border:none;
}

.song-item{
  background:#1e1e1e;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  cursor:pointer;
}

.editor{
  position:relative;
  font-family:monospace;
  white-space:pre;
  line-height:2.2em;
}

.line{
  position:relative;
}

.chord{
  position:absolute;
  top:-1.4em;
  color:#00eaff;
  font-weight:bold;
  cursor:pointer;
}

.modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal-content{
  background:#222;
  padding:20px;
  border-radius:10px;
  width:380px;
  text-align:center;
}

#diagramContainer svg{
  background:#f5f5f5;
  border-radius:10px;
}
</style>
</head>
<body>

<header>üé∏ Chord Studio Pro</header>

<div class="container" id="homePage">
  <h3>‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
  <div id="songList"></div>

  <input id="newSongTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á">
  <button class="primary" onclick="createSong()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á</button>
</div>

<div class="container" id="editorPage" style="display:none;">
  <button onclick="goHome()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
  <h3 id="songTitle"></h3>

  <textarea id="lyricsInput" rows="6" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á"></textarea>

  <input id="chordNameInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏î (‡πÄ‡∏ä‡πà‡∏ô C, Am, F#m)">
  <button class="primary" onclick="addChord()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏î</button>

  <div id="preview" class="editor"></div>
</div>

<div class="modal" id="diagramModal">
  <div class="modal-content">
    <h3 id="modalChordName"></h3>

    <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ü‡∏£‡∏ï:</label>
    <input type="number" id="startFretInput" value="1">

    <button class="secondary" onclick="toggleDeleteMode()" id="deleteModeBtn">
      ‡πÇ‡∏´‡∏°‡∏î: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡πâ‡∏ß
    </button>

    <div id="diagramContainer"></div>

    <button class="primary" onclick="saveDiagram()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="danger" onclick="deleteChord()">‡∏•‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏î</button>
    <button class="secondary" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
let songs = JSON.parse(localStorage.getItem("songs")) || [];
let chordDiagrams = JSON.parse(localStorage.getItem("chordDiagrams")) || {};

let currentSongIndex = null;
let currentChordIndex = null;

let diagramData = { startFret:1, dots:[] };
let deleteMode = false;

function saveSongs(){
  localStorage.setItem("songs", JSON.stringify(songs));
}

function renderSongList(){
  const list = document.getElementById("songList");
  list.innerHTML="";
  songs.forEach((song,index)=>{
    const div=document.createElement("div");
    div.className="song-item";
    div.innerText=song.title;
    div.onclick=()=>openSong(index);
    list.appendChild(div);
  });
}

function createSong(){
  const title=document.getElementById("newSongTitle").value;
  if(!title) return;
  songs.push({title, lyrics:"", chords:[]});
  saveSongs();
  renderSongList();
  document.getElementById("newSongTitle").value="";
}

function openSong(index){
  currentSongIndex=index;
  document.getElementById("homePage").style.display="none";
  document.getElementById("editorPage").style.display="block";
  document.getElementById("songTitle").innerText=songs[index].title;
  document.getElementById("lyricsInput").value=songs[index].lyrics;
  renderPreview();
}

function goHome(){
  document.getElementById("homePage").style.display="block";
  document.getElementById("editorPage").style.display="none";
  saveSongs();
  renderSongList();
}

document.getElementById("lyricsInput").addEventListener("input",()=>{
  songs[currentSongIndex].lyrics=document.getElementById("lyricsInput").value;
  renderPreview();
});

function addChord(){
  const name=document.getElementById("chordNameInput").value;
  if(!name) return;

  songs[currentSongIndex].chords.push({
    name,
    position: document.getElementById("lyricsInput").selectionStart
  });

  document.getElementById("chordNameInput").value="";
  renderPreview();
  saveSongs();
}

function renderPreview(){
  const song = songs[currentSongIndex];
  const preview = document.getElementById("preview");
  preview.innerHTML = "";

  const lyrics = song.lyrics;
  const chords = song.chords;

  let container = document.createElement("div");
  container.style.position = "relative";
  container.style.whiteSpace = "pre-wrap";
  container.style.fontFamily = "monospace";
  container.style.lineHeight = "2.2em";

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á span ‡∏ï‡πà‡∏≠ 1 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
  for(let i=0;i<lyrics.length;i++){
    const span = document.createElement("span");
    span.innerText = lyrics[i];
    span.dataset.index = i;
    container.appendChild(span);
  }

  preview.appendChild(container);

  // ‡∏ß‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏î
  chords.forEach((chord,index)=>{
    const target = container.querySelector(`span[data-index='${chord.position}']`);
    if(!target) return;

    const rect = target.getBoundingClientRect();
    const parentRect = container.getBoundingClientRect();

    const chordEl = document.createElement("span");
    chordEl.innerText = chord.name;
    chordEl.className = "chord";
    chordEl.style.position = "absolute";
    chordEl.style.left = (rect.left - parentRect.left) + "px";
    chordEl.style.top = (rect.top - parentRect.top - 22) + "px";
    chordEl.style.cursor = "pointer";
    chordEl.style.color = "#00eaff";
    chordEl.style.fontWeight = "bold";
    chordEl.onclick = ()=>openModal(index);

    container.appendChild(chordEl);
  });
}
function openModal(index){
  currentChordIndex=index;
  const chord=songs[currentSongIndex].chords[index];
  document.getElementById("modalChordName").innerText=chord.name;
  document.getElementById("diagramModal").style.display="flex";

  if(chordDiagrams[chord.name]){
    diagramData=JSON.parse(JSON.stringify(chordDiagrams[chord.name]));
  }else{
    diagramData={startFret:1,dots:[]};
  }

  document.getElementById("startFretInput").value=diagramData.startFret;
  renderDiagram();
}

function closeModal(){
  document.getElementById("diagramModal").style.display="none";
}

function toggleDeleteMode(){
  deleteMode = !deleteMode;
  const btn = document.getElementById("deleteModeBtn");

  if(deleteMode){
    btn.innerText="‡πÇ‡∏´‡∏°‡∏î: ‡∏•‡∏ö‡∏ô‡∏¥‡πâ‡∏ß";
    btn.style.background="#ff4444";
  }else{
    btn.innerText="‡πÇ‡∏´‡∏°‡∏î: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡πâ‡∏ß";
    btn.style.background="#444";
  }
}

function renderDiagram(){
  const container=document.getElementById("diagramContainer");
  container.innerHTML="";

  const width=260, height=320;
  const strings=6, frets=5;
  const spacingX=30, spacingY=40;
  const offsetX=60, offsetY=60;

  const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("width",width);
  svg.setAttribute("height",height);

  for(let i=0;i<strings;i++){
    const line=document.createElementNS(svg.namespaceURI,"line");
    line.setAttribute("x1",offsetX+i*spacingX);
    line.setAttribute("y1",offsetY);
    line.setAttribute("x2",offsetX+i*spacingX);
    line.setAttribute("y2",offsetY+frets*spacingY);
    line.setAttribute("stroke","#555");
    line.setAttribute("stroke-width","2");
    svg.appendChild(line);
  }

  for(let i=0;i<=frets;i++){
    const line=document.createElementNS(svg.namespaceURI,"line");
    line.setAttribute("x1",offsetX);
    line.setAttribute("y1",offsetY+i*spacingY);
    line.setAttribute("x2",offsetX+(strings-1)*spacingX);
    line.setAttribute("y2",offsetY+i*spacingY);
    line.setAttribute("stroke","#555");
    line.setAttribute("stroke-width","2");
    svg.appendChild(line);
  }

  for(let i=0;i<frets;i++){
    const text=document.createElementNS(svg.namespaceURI,"text");
    text.setAttribute("x",20);
    text.setAttribute("y",offsetY+(i+1)*spacingY-10);
    text.textContent=parseInt(document.getElementById("startFretInput").value)+i;
    text.setAttribute("font-size","14");
    svg.appendChild(text);
  }

  diagramData.dots.forEach(d=>{
    const cx=offsetX+d.string*spacingX;
    const cy=offsetY+(d.fret-0.5)*spacingY;

    const circle=document.createElementNS(svg.namespaceURI,"circle");
    circle.setAttribute("cx",cx);
    circle.setAttribute("cy",cy);
    circle.setAttribute("r","12");
    circle.setAttribute("fill","black");
    svg.appendChild(circle);

    const finger=document.createElementNS(svg.namespaceURI,"text");
    finger.setAttribute("x",cx);
    finger.setAttribute("y",cy+5);
    finger.setAttribute("text-anchor","middle");
    finger.setAttribute("fill","white");
    finger.setAttribute("font-size","12");
    finger.textContent=d.finger;
    svg.appendChild(finger);
  });

  svg.addEventListener("click",(e)=>{
    const rect=svg.getBoundingClientRect();
    const x=e.clientX-rect.left;
    const y=e.clientY-rect.top;

    const string=Math.round((x-offsetX)/spacingX);
    const fret=Math.floor((y-offsetY)/spacingY)+1;

    if(string>=0 && string<6 && fret>=1 && fret<=5){

      if(deleteMode){
        diagramData.dots = diagramData.dots.filter(d =>
          !(d.string==string && d.fret==fret)
        );
        renderDiagram();
        return;
      }

      const finger=prompt("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ô‡∏¥‡πâ‡∏ß (1-4):");
      if(!finger) return;

      diagramData.dots.push({string,fret,finger});
      renderDiagram();
    }
  });

  container.appendChild(svg);
}

function saveDiagram(){
  diagramData.startFret=parseInt(document.getElementById("startFretInput").value);
  const chordName=songs[currentSongIndex].chords[currentChordIndex].name;
  chordDiagrams[chordName]=diagramData;
  localStorage.setItem("chordDiagrams",JSON.stringify(chordDiagrams));
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
}

function deleteChord(){
  songs[currentSongIndex].chords.splice(currentChordIndex,1);
  saveSongs();
  renderPreview();
  closeModal();
}

renderSongList();
</script>
</body>

</html>

